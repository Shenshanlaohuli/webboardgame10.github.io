<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tricky Kids</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-yellow: #ffcf33;
            --card-red: #ff5e5e;
            --card-blue: #5e97ff;
        }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, sans-serif;
            background-color: #1a1a1a;
            color: #333;
            overflow: hidden; touch-action: manipulation;
        }

        #game-container {
            width: 100vw; height: 100vh; max-width: 500px; margin: 0 auto;
            background: var(--bg-color); position: relative;
            display: flex; flex-direction: column;
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; }
        .screen.active { display: flex; }

        /* å¼€å§‹ç•Œé¢ */
        #start-screen { justify-content: center; background: #2c3e50; color: white; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        
        button { 
            padding: 12px 20px; font-size: 16px; border: none; border-radius: 8px; 
            background: #fff; color: #2c3e50; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:active { transform: scale(0.95); }
        .primary-btn { background: #27ae60; color: white; width: 80%; margin: 8px 0; height: 44px; }
        .random-btn { background: #f39c12; color: white; margin-bottom: 5px; padding: 10px; }

        /* çŠ¶æ€ & åˆ†æ•°å¡ */
        #status-bar { width: 100%; background: #333; color: white; padding: 6px 0; display: flex; justify-content: space-around; font-size: 11px; }
        #score-cards-area { height: 75px; width: 100%; display: flex; justify-content: center; gap: 4px; padding: 5px; box-sizing: border-box; background: #ddd; z-index: 10; }
        
        .score-card { 
            width: 13%; height: 60px; border: 1px solid #999; border-radius: 4px; font-size: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; 
        }
        .score-card.active { border: 2px solid #e67e22; box-shadow: 0 0 5px rgba(230,126,34,0.5); }
        .score-card.discarded { opacity: 0.2; filter: grayscale(1); }

        /* æ¸¸æˆåŒºåŸŸ */
        #play-area { flex: 1; position: relative; width: 100%; display: flex; flex-direction: column; overflow: hidden; }
        #table { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; min-height: 200px; }
        .table-slot { position: absolute; display: flex; flex-direction: column; align-items: center; transform: scale(0.9); }

        /* æ‰‹ç‰ŒåŒºåŸŸ - å¢åŠ åº•éƒ¨è¾¹è·é¿å…è¢«æ‰‹æœºç³»ç»Ÿæ¡é®æŒ¡ */
        #hand-container { 
            background: #bbb; 
            padding: 10px 10px 45px 10px; /* åº•éƒ¨å¢åŠ  45px ç•™ç™½ï¼Œä¸Šç§»æ‰‹ç‰Œ */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            border-top: 2px solid #999; 
            width: 100%;
            box-sizing: border-box;
        }
        #hand-area { display: flex; justify-content: center; width: 100%; height: 85px; margin-bottom: 8px; }

        .card { 
            width: 48px; height: 70px; border-radius: 6px; border: 1px solid #333; 
            position: relative; margin-left: -20px; box-shadow: 2px 2px 4px rgba(0,0,0,0.2); 
            background-color: white; transition: transform 0.15s;
        }
        .card:first-child { margin-left: 0; }
        .card.selected { transform: translateY(-20px); border: 2.5px solid #000; z-index: 50; }
        .card.disabled { filter: grayscale(1); opacity: 0.5; pointer-events: none; }
        .card-val { position: absolute; top: 2px; left: 4px; font-weight: bold; font-size: 14px; pointer-events: none; }

        .yellow { background-color: var(--card-yellow); }
        .red { background-color: var(--card-red); color: white; }
        .blue { background-color: var(--card-blue); color: white; }

        /* åˆ†é…åˆ—è¡¨ä¼˜åŒ– - é™åˆ¶é«˜åº¦é˜²æ­¢æŒ‰é’®æ‰å‡ºå±å¹• */
        #assign-list { width: 95%; overflow-y: auto; max-height: 45vh; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; background: rgba(0,0,0,0.05); }
        .assign-row { display: flex; align-items: center; justify-content: space-between; background: #fff; margin-bottom: 2px; padding: 6px 12px; border-radius: 4px; }
        .assign-row input[type="number"] { width: 50px; font-size: 18px; text-align: center; border: 1px solid #ccc; }

        /* ç»“æœç•Œé¢ */
        #result-screen { justify-content: center; background: #2c3e50; color: white; }
        .ranking-list { width: 85%; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; }
        .ranking-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); font-size: 20px; }

        #msg-log { 
            position: absolute; top: 135px; width: 100%; text-align: center; font-weight: bold; 
            color: #d35400; z-index: 5; height: 24px; text-shadow: 1px 1px 2px white; pointer-events: none;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="start-screen" class="screen active">
        <h1 style="font-size: 42px; margin: 10px;">Tricky Kids</h1>
        <div class="btn-group">
            <button onclick="setupGame(2)">2äºº</button>
            <button onclick="setupGame(3)">3äºº</button>
            <button onclick="setupGame(4)">4äºº</button>
            <button onclick="setupGame(5)">5äºº</button>
            <button onclick="setupGame(6)">6äºº</button>
        </div>
    </div>

    <div id="assign-screen" class="screen">
        <h3 style="margin: 10px 0 5px;">åˆ†é… 21 ç‚¹ (é€‰7å¼ )</h3>
        <button class="random-btn" onclick="autoAssign()">ğŸ² éšæœºåˆ†é… (0-7)</button>
        <div id="assign-list"></div>
        <div style="font-size: 16px; margin: 5px 0;">
            å·²é€‰: <span id="sel-count">0</span>/7 | æ€»è®¡: <span id="current-sum">0</span>/21
        </div>
        <button id="assign-done-btn" class="primary-btn" onclick="finishAssignment()">ç¡®è®¤å¹¶å¼€å§‹</button>
        <div style="height: 20px;"></div> <!-- åº•éƒ¨ç¼“å†² -->
    </div>

    <div id="main-screen" class="screen">
        <div id="status-bar"></div>
        <div id="score-cards-area"></div>
        <div id="msg-log"></div>
        <div id="play-area">
            <div id="table"></div>
            <div id="hand-container">
                <div id="turn-info" style="font-size:13px; margin-bottom:5px; color:#333; font-weight:bold;"></div>
                <div id="hand-area"></div>
                <button id="play-btn" class="primary-btn" style="display:none; width:150px; margin:0;" onclick="humanPlay()">å‡ºç‰Œ</button>
            </div>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <h1 style="color:#f1c40f">æ¸¸æˆç»“æŸ</h1>
        <div class="ranking-list" id="final-ranking"></div>
        <button class="primary-btn" style="margin-top: 30px" onclick="location.reload()">å†ç©ä¸€å±€</button>
    </div>
</div>

<script>
    // é€»è¾‘éƒ¨åˆ†ä¿æŒä¸€è‡´ï¼Œä»…å¯¹ executeCard çš„ UI åˆ·æ–°åšäº†å¾®è°ƒ
    const COLORS = ['yellow', 'red', 'blue'];
    const CHN_COLORS = { yellow: 'é»„', red: 'çº¢', blue: 'è“' };
    let playerCount, players, round = 1;
    let scorePool = [], currentScoreCards = [], currentScoreCardIdx = 0;
    let firstPlayerIdx = 0, currentPlayerIdx = 0, trickLeadSuit = null, currentTrick = [];

    function setupGame(num) {
        playerCount = num;
        players = Array.from({length: num}, (_, i) => ({
            id: i, name: i===0 ? "ä½ " : "ç”µè„‘"+i, isAI: i!==0, hand: [], score: 0
        }));
        initScorePool();
        startRound();
    }

    function initScorePool() {
        const combos = [[1,3,3], [3,1,3], [3,3,1], [2,0,5], [2,5,0], [0,2,5], [0,5,2], [5,2,0], [5,0,2], [1,2,4], [1,4,2], [4,2,1], [4,1,2], [2,1,4], [2,4,1], [2,3,3], [3,2,3], [3,3,2], [1,1,5], [1,5,1], [5,1,1]];
        scorePool = combos.map(c => ({yellow:c[0], red:c[1], blue:c[2], status:'active'})).sort(()=>Math.random()-0.5);
    }

    function startRound() {
        currentScoreCards = scorePool.splice(0, 7);
        currentScoreCardIdx = 0;
        let deck = [];
        COLORS.forEach(c => { for(let i=0; i<18; i++) deck.push({suit:c, value:0}); });
        deck.sort(() => Math.random() - 0.5);

        players.forEach(p => {
            p.hand = deck.splice(0, 9);
            if(p.isAI) {
                p.hand = p.hand.slice(0, 7);
                let sum = 0, target = 21;
                for(let i=0; i<6; i++) {
                    let v = Math.floor(Math.random() * Math.min(target - (6-i), 7));
                    p.hand[i].value = v; sum += v; target -= v;
                }
                p.hand[6].value = target;
            }
        });
        renderAssignScreen();
    }

    function renderAssignScreen() {
        showScreen('assign-screen');
        const list = document.getElementById('assign-list');
        list.innerHTML = '';
        players[0].hand.forEach((card, i) => {
            const row = document.createElement('div');
            row.className = 'assign-row';
            row.innerHTML = `
                <input type="checkbox" class="a-cb" onchange="updateAssignUI()">
                <div class="card ${card.suit}" style="margin:0; width:32px; height:45px"></div>
                <input type="number" class="a-iv" value="0" min="0" max="21" oninput="updateAssignUI()">
            `;
            list.appendChild(row);
        });
        updateAssignUI();
    }

    function autoAssign() {
        const cbs = document.querySelectorAll('.a-cb');
        const ivs = document.querySelectorAll('.a-iv');
        let indices = [0,1,2,3,4,5,6,7,8].sort(()=>Math.random()-0.5).slice(0,7);
        cbs.forEach((cb, i) => cb.checked = indices.includes(i));
        
        let points = [0,0,0,0,0,0,0], sum = 0;
        while(sum < 21) {
            let r = Math.floor(Math.random()*7);
            if(points[r] < 7) { points[r]++; sum++; }
        }
        let pIdx = 0;
        ivs.forEach((iv, i) => {
            if(indices.includes(i)) { iv.value = points[pIdx++]; }
            else { iv.value = 0; }
        });
        updateAssignUI();
    }

    function updateAssignUI() {
        let count = 0, sum = 0;
        document.querySelectorAll('.a-cb').forEach((cb, i) => {
            if(cb.checked) {
                count++;
                sum += parseInt(document.querySelectorAll('.a-iv')[i].value) || 0;
            }
        });
        document.getElementById('sel-count').innerText = count;
        document.getElementById('current-sum').innerText = sum;
        document.getElementById('assign-done-btn').disabled = (count !== 7 || sum !== 21);
    }

    function finishAssignment() {
        let selected = [];
        document.querySelectorAll('.a-cb').forEach((cb, i) => {
            if(cb.checked) {
                let card = players[0].hand[i];
                card.value = parseInt(document.querySelectorAll('.a-iv')[i].value) || 0;
                selected.push(card);
            }
        });
        players[0].hand = selected;
        startTrick();
    }

    function startTrick() {
        showScreen('main-screen');
        currentTrick = [];
        trickLeadSuit = null;
        currentPlayerIdx = firstPlayerIdx;
        renderScoreArea();
        updateStatus();
        nextTurn();
    }

    function nextTurn() {
        const p = players[currentPlayerIdx];
        renderTable();
        if(p.isAI) {
            document.getElementById('turn-info').innerText = `${p.name} æ­£åœ¨å‡ºç‰Œ...`;
            setTimeout(() => aiPlay(p), 700);
        } else {
            document.getElementById('turn-info').innerText = `ä½ çš„å›åˆ - è¯·å‡ºç‰Œ`;
            renderHumanHand();
        }
    }

    function renderHumanHand() {
        const area = document.getElementById('hand-area');
        area.innerHTML = '';
        const canFollow = players[0].hand.some(c => c.suit === trickLeadSuit);
        
        players[0].hand.forEach((card, i) => {
            const div = document.createElement('div');
            const isLegal = !trickLeadSuit || card.suit === trickLeadSuit || !canFollow;
            div.className = `card ${card.suit} ${isLegal ? '' : 'disabled'}`;
            div.innerHTML = `<span class="card-val">${card.value}</span>`;
            div.onclick = () => {
                if(!isLegal) return;
                document.querySelectorAll('#hand-area .card').forEach(c => c.classList.remove('selected'));
                div.classList.add('selected');
                div.dataset.index = i;
                document.getElementById('play-btn').style.display = 'block';
            };
            area.appendChild(div);
        });
    }

    function humanPlay() {
        const sel = document.querySelector('.card.selected');
        if(!sel) return;
        const idx = parseInt(sel.dataset.index);
        document.getElementById('play-btn').style.display = 'none';
        executeCard(0, idx);
    }

    function aiPlay(p) {
        const canFollow = p.hand.filter(c => c.suit === trickLeadSuit);
        let idx = -1;
        if(trickLeadSuit && canFollow.length > 0) {
            idx = p.hand.indexOf(canFollow[Math.floor(Math.random()*canFollow.length)]);
        } else {
            idx = Math.floor(Math.random()*p.hand.length);
        }
        executeCard(p.id, idx);
    }

    function executeCard(pIdx, cardIdx) {
        const card = players[pIdx].hand.splice(cardIdx, 1)[0];
        if(!trickLeadSuit) trickLeadSuit = card.suit;
        currentTrick.push({pIdx, card});
        
        if (pIdx === 0) renderHumanHand(); 
        renderTable();

        currentPlayerIdx = (currentPlayerIdx + 1) % playerCount;

        if(currentTrick.length === playerCount) {
            setTimeout(resolveTrick, 800);
        } else {
            nextTurn();
        }
    }

    function resolveTrick() {
        const getValid = (list) => {
            const counts = {};
            list.forEach(t => counts[t.card.value] = (counts[t.card.value] || 0) + 1);
            return list.filter(t => counts[t.card.value] === 1);
        };

        let leadCards = currentTrick.filter(t => t.card.suit === trickLeadSuit);
        let validLeads = getValid(leadCards);
        let winnerObj = null;

        if(validLeads.length > 0) {
            winnerObj = validLeads.sort((a,b) => b.card.value - a.card.value)[0];
        } else {
            let otherCards = currentTrick.filter(t => t.card.suit !== trickLeadSuit);
            let validOthers = getValid(otherCards);
            if(validOthers.length > 0) {
                winnerObj = validOthers.sort((a,b) => b.card.value - a.card.value)[0];
            }
        }

        const log = document.getElementById('msg-log');
        if(!winnerObj) {
            log.innerText = "æ‰€æœ‰äººæ‰“å¹³ï¼Œå¡ç‰Œå¼ƒç½®";
            currentScoreCards[currentScoreCardIdx].status = 'discarded';
            firstPlayerIdx = (currentTrick[0].pIdx + 1) % playerCount;
        } else if(winnerObj.card.value === 0) {
            log.innerText = `${players[winnerObj.pIdx].name} ç”¨ 0 èµ¢ï¼Œå¡ç‰Œå¼ƒç½®`;
            currentScoreCards[currentScoreCardIdx].status = 'discarded';
            firstPlayerIdx = winnerObj.pIdx;
        } else {
            const points = currentScoreCards[currentScoreCardIdx][winnerObj.card.suit];
            players[winnerObj.pIdx].score += points;
            log.innerText = `${players[winnerObj.pIdx].name} èµ¢ (${points}åˆ†)`;
            firstPlayerIdx = winnerObj.pIdx;
        }

        currentScoreCardIdx++;
        setTimeout(() => {
            log.innerText = "";
            if(currentScoreCardIdx >= 7) endRound();
            else startTrick();
        }, 1200);
    }

    function endRound() {
        if(round >= 3) {
            showFinalResults();
            return;
        }
        round++;
        const min = Math.min(...players.map(p => p.score));
        const candidates = players.filter(p => p.score === min);
        firstPlayerIdx = candidates[Math.floor(Math.random()*candidates.length)].id;
        startRound();
    }

    function showFinalResults() {
        showScreen('result-screen');
        const list = document.getElementById('final-ranking');
        list.innerHTML = '';
        const sorted = [...players].sort((a,b) => b.score - a.score);
        sorted.forEach((p, i) => {
            const item = document.createElement('div');
            item.className = 'ranking-item';
            item.innerHTML = `<span>#${i+1} ${p.name}</span><span>${p.score} åˆ†</span>`;
            list.appendChild(item);
        });
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function renderScoreArea() {
        const area = document.getElementById('score-cards-area');
        area.innerHTML = '';
        currentScoreCards.forEach((sc, i) => {
            const div = document.createElement('div');
            div.className = `score-card ${i===currentScoreCardIdx?'active':''} ${sc.status==='discarded'?'discarded':''}`;
            div.innerHTML = `
                <span style="color:#b8860b">é»„:${sc.yellow}</span>
                <span style="color:#c0392b">çº¢:${sc.red}</span>
                <span style="color:#2980b9">è“:${sc.blue}</span>
            `;
            area.appendChild(div);
        });
    }

    function renderTable() {
        const table = document.getElementById('table');
        table.innerHTML = '';
        const radius = 95;
        currentTrick.forEach((t, i) => {
            const angle = (t.pIdx * (360/playerCount) - 90) * (Math.PI/180);
            const x = Math.cos(angle)*radius, y = Math.sin(angle)*radius;
            const slot = document.createElement('div');
            slot.className = 'table-slot';
            slot.style.left = `calc(50% + ${x}px - 24px)`;
            slot.style.top = `calc(50% + ${y}px - 40px)`;
            slot.innerHTML = `
                <div class="card ${t.card.suit}" style="margin:0">
                    <span class="card-val">${t.card.value}</span>
                </div>
                <div style="font-size:10px; margin-top:2px;">${players[t.pIdx].name}</div>
            `;
            table.appendChild(slot);
        });
    }

    function updateStatus() {
        document.getElementById('status-bar').innerHTML = players.map(p => `<span>${p.name}:<b>${p.score}</b></span>`).join('');
    }
</script>
</body>
</html>