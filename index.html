<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tricky Kids</title>
    <style>
        :root {
            --bg-dark: #121212;
            --panel-dark: #1e1e1e;
            --item-dark: #2c2c2c;
            --text-light: #e0e0e0;
            --card-yellow: #ffcf33;
            --card-red: #ff5e5e;
            --card-blue: #5e97ff;
            --accent-green: #2ecc71;
            --accent-orange: #f39c12;
        }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, sans-serif;
            background-color: #000;
            color: var(--text-light);
            overflow: hidden; touch-action: manipulation;
        }

        #game-container {
            width: 100vw; height: 100vh; max-width: 500px; margin: 0 auto;
            background: var(--bg-dark); position: relative;
            display: flex; flex-direction: column;
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; background: var(--bg-dark); }
        .screen.active { display: flex; }

        /* å¼€å§‹ç•Œé¢ */
        #start-screen { justify-content: flex-start; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .rule-box { 
            background: var(--panel-dark); padding: 15px; border-radius: 12px; 
            font-size: 13px; line-height: 1.5; color: #bbb; margin-bottom: 20px; 
            width: 100%; box-sizing: border-box; border: 1px solid #333;
        }
        .rule-box h2 { margin: 0 0- 10px 0; color: var(--accent-orange); font-size: 18px; text-align: center; }
        .rule-tag { background: #444; color: #fff; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 4px; }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-bottom: 20px; }
        
        button { 
            padding: 12px 10px; font-size: 16px; border: none; border-radius: 8px; 
            background: #333; color: white; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 0 #000;
        }
        button:active { transform: translateY(2px); box-shadow: 0 2px 0 #000; }
        .primary-btn { background: var(--accent-green); color: white; width: 80%; margin: 8px 0; height: 44px; flex-shrink: 0; box-shadow: 0 4px 0 #1b7a43; }
        .random-btn { background: var(--accent-orange); color: white; margin-bottom: 8px; padding: 10px; box-shadow: 0 4px 0 #a66b0d; width: 90%; }

        /* é€šç”¨é¡¶éƒ¨ï¼šçŠ¶æ€æ  + åˆ†æ•°å¡ */
        #common-header { width: 100%; background: #000; z-index: 100; }
        #status-bar { width: 100%; padding: 6px 0; display: flex; justify-content: space-around; font-size: 11px; border-bottom: 1px solid #222; color: #888; }
        #status-bar b { color: #fff; }
        
        #score-cards-area { 
            height: 75px; width: 100%; display: flex; justify-content: center; 
            gap: 4px; padding: 5px; box-sizing: border-box; background: #1a1a1a; 
        }
        .score-card { 
            width: 13%; height: 60px; border: 1px solid #333; border-radius: 4px; font-size: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; background: #252525; color: #eee;
        }
        .score-card.active { border: 2px solid var(--accent-orange); background: #333; }
        .score-card.discarded { opacity: 0.1; filter: grayscale(1); }

        /* åˆ†é…é˜¶æ®µç‰¹æœ‰æç¤º */
        #assign-tip { font-size: 12px; color: var(--accent-orange); background: rgba(243, 156, 18, 0.1); width: 100%; text-align: center; padding: 4px 0; border-bottom: 1px solid #333; }

        /* æ¸¸æˆåŒºåŸŸ */
        #play-area { flex: 1; position: relative; width: 100%; display: flex; flex-direction: column; overflow: hidden; }
        #table { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; min-height: 180px; }
        .table-slot { position: absolute; display: flex; flex-direction: column; align-items: center; transform: scale(0.85); }

        /* æ‰‹ç‰ŒåŒº */
        #hand-container { 
            background: #1a1a1a; padding: 8px 10px 45px 10px; display: flex; 
            flex-direction: column; align-items: center; border-top: 1px solid #333; width: 100%; box-sizing: border-box;
        }
        #hand-area { display: flex; justify-content: center; width: 100%; height: 80px; margin-bottom: 8px; }

        /* å¡ç‰Œæ ·å¼ */
        .card { 
            width: 46px; height: 68px; border-radius: 6px; border: 1px solid #000; 
            position: relative; margin-left: -18px; box-shadow: 2px 2px 6px rgba(0,0,0,0.5); 
            background-color: #fff; transition: transform 0.15s; color: #000;
        }
        .card:first-child { margin-left: 0; }
        .card.selected { transform: translateY(-15px); border: 2px solid #fff; z-index: 50; }
        .card.disabled { filter: grayscale(1); opacity: 0.15; pointer-events: none; }
        .card-val { position: absolute; top: 2px; left: 4px; font-weight: bold; font-size: 14px; pointer-events: none; }

        .yellow { background-color: var(--card-yellow); }
        .red { background-color: var(--card-red); color: white; }
        .blue { background-color: var(--card-blue); color: white; }

        /* åˆ†é…åˆ—è¡¨é¡¹ */
        #assign-list { width: 95%; overflow-y: auto; max-height: 38vh; margin: 5px 0; border: 1px solid #333; border-radius: 8px; background: #000; }
        .assign-row { display: flex; align-items: center; justify-content: space-between; background: var(--item-dark); margin-bottom: 2px; padding: 6px 12px; border-radius: 4px; }
        .assign-row input[type="number"] { width: 55px; font-size: 20px; text-align: center; border: 1px solid #444; background: #111; color: #fff; border-radius: 4px; padding: 4px 0; }

        #result-screen { justify-content: center; padding: 20px; }
        .ranking-list { width: 90%; background: var(--panel-dark); padding: 15px; border-radius: 12px; }
        .ranking-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #333; font-size: 20px; }

        #msg-log { position: absolute; top: 135px; width: 100%; text-align: center; font-weight: bold; color: var(--accent-orange); z-index: 5; text-shadow: 1px 1px 1px #000; pointer-events: none; }
    </style>
</head>
<body>

<div id="game-container">
    <!-- é€šç”¨å¤´éƒ¨ (åœ¨åˆ†é…å’Œæˆ˜æ–—æ—¶å‡æ˜¾ç¤º) -->
    <div id="common-header" style="display:none;">
        <div id="status-bar"></div>
        <div id="score-cards-area"></div>
    </div>

    <!-- 1. å¼€å§‹ç•Œé¢ -->
    <div id="start-screen" class="screen active">
        <h1 style="font-size: 32px; margin: 15px 0; color: #fff;">Tricky Kids</h1>
        
        <div class="rule-box">
            <h2>ğŸ“œ æ ¸å¿ƒç­–ç•¥</h2>
            <p><span class="rule-tag">1</span> æ¯ä¸€è½®ä¼šå…ˆç¿»å¼€<span style="color:var(--accent-orange)">7å¼ åˆ†æ•°å¡</span>ï¼Œè¯·æ ¹æ®åˆ†æ•°é¢œè‰²åˆ†é…ä½ çš„ç‚¹æ•°ã€‚</p>
            <p><span class="rule-tag">2</span> å¿…é¡»<span style="color:var(--accent-orange)">è·ŸéšèŠ±è‰²</span>ã€‚è‹¥æ²¡è¯¥è‰²ç‰Œåˆ™å¯ä»»å‡ºä¸€å¼ ã€‚</p>
            <p><span class="rule-tag">3</span> åŒèŠ±è‰²<span style="color:var(--accent-orange)">ç‚¹æ•°æœ€é«˜</span>è·èƒœã€‚ç‚¹æ•°ç›¸åŒåˆ™æŠµæ¶ˆï¼Œæ¯”å…¶ä»–èŠ±è‰²æœ€å¤§ç‰Œã€‚</p>
            <p><span class="rule-tag">4</span> èµ¢å®¶æŒ‰è·èƒœèŠ±è‰²æ‹¿åˆ†ã€‚0ç‚¹èµ¢ä¸æ‹¿åˆ†ã€‚åˆ†ä½è€…ä¸‹è½®å…ˆæ‰‹ã€‚</p>
        </div>

        <p style="margin-bottom: 15px; font-weight: bold; color: #888;">é€‰æ‹©äººæ•°å¼€å§‹ (vs AI)ï¼š</p>
        <div class="btn-group">
            <button onclick="setupGame(2)">2äººå¯¹æˆ˜</button>
            <button onclick="setupGame(3)">3äººå¯¹æˆ˜</button>
            <button onclick="setupGame(4)">4äººå¯¹æˆ˜</button>
            <button onclick="setupGame(5)">5äººå¯¹æˆ˜</button>
            <button onclick="setupGame(6)">6äººå¯¹æˆ˜</button>
        </div>
    </div>

    <!-- 2. åˆ†é…ç•Œé¢ -->
    <div id="assign-screen" class="screen">
        <div id="assign-tip">è¯·å‚ç…§ä¸Šæ–¹åˆ†æ•°å¡åˆ†é…ä½ çš„ 21 ç‚¹</div>
        <div id="assign-list"></div>
        <div style="font-size: 15px; margin: 8px 0; color: #888;">
            å·²é€‰: <span id="sel-count" style="color:#fff">0</span>/7 | æ€»è®¡: <span id="current-sum" style="color:#fff">0</span>/21
        </div>
        <button class="random-btn" onclick="autoAssign()">ğŸ² éšæœºåˆ†é… (0-7)</button>
        <button id="assign-done-btn" class="primary-btn" onclick="finishAssignment()">åˆ†é…å®Œæˆï¼Œå¼€å§‹æˆ˜æ–—</button>
    </div>

    <!-- 3. ä¸»ç•Œé¢ -->
    <div id="main-screen" class="screen">
        <div id="msg-log"></div>
        <div id="play-area">
            <div id="table"></div>
            <div id="hand-container">
                <div id="turn-info" style="font-size: 13px; color: #666; margin-bottom: 5px;"></div>
                <div id="hand-area"></div>
                <button id="play-btn" class="primary-btn" style="display:none; width:150px; margin:0;" onclick="humanPlay()">å‡ºç‰Œ</button>
            </div>
        </div>
    </div>

    <!-- 4. ç»“æœç•Œé¢ -->
    <div id="result-screen" class="screen">
        <h1 style="color:var(--accent-orange); font-size: 32px;">æœ€ç»ˆç»“ç®—</h1>
        <div class="ranking-list" id="final-ranking"></div>
        <button class="primary-btn" style="margin-top: 30px" onclick="location.reload()">å›åˆ°ä¸»èœå•</button>
    </div>
</div>

<script>
    const COLORS = ['yellow', 'red', 'blue'];
    const CHN_COLORS = { yellow: 'é»„', red: 'çº¢', blue: 'è“' };
    let playerCount, players, round = 1;
    let scorePool = [], currentScoreCards = [], currentScoreCardIdx = 0;
    let firstPlayerIdx = 0, currentPlayerIdx = 0, trickLeadSuit = null, currentTrick = [];

    function setupGame(num) {
        playerCount = num;
        players = Array.from({length: num}, (_, i) => ({
            id: i, name: i===0 ? "ä½ " : "ç”µè„‘"+i, isAI: i!==0, hand: [], score: 0
        }));
        initScorePool();
        startRound();
    }

    function initScorePool() {
        const combos = [[1,3,3], [3,1,3], [3,3,1], [2,0,5], [2,5,0], [0,2,5], [0,5,2], [5,2,0], [5,0,2], [1,2,4], [1,4,2], [4,2,1], [4,1,2], [2,1,4], [2,4,1], [2,3,3], [3,2,3], [3,3,2], [1,1,5], [1,5,1], [5,1,1]];
        scorePool = combos.map(c => ({yellow:c[0], red:c[1], blue:c[2], status:'active'})).sort(()=>Math.random()-0.5);
    }

    function startRound() {
        currentScoreCards = scorePool.splice(0, 7);
        currentScoreCardIdx = 0;
        
        // åˆ†é…å‰å…ˆç¿»å¼€åˆ†æ•°å¡å¹¶æ˜¾ç¤ºå¤´éƒ¨
        document.getElementById('common-header').style.display = 'block';
        renderScoreArea();
        updateStatus();

        let deck = [];
        COLORS.forEach(c => { for(let i=0; i<18; i++) deck.push({suit:c, value:0}); });
        deck.sort(() => Math.random() - 0.5);

        players.forEach(p => {
            p.hand = deck.splice(0, 9);
            if(p.isAI) {
                p.hand = p.hand.slice(0, 7);
                let sum = 0, target = 21;
                for(let i=0; i<6; i++) {
                    let v = Math.floor(Math.random() * Math.min(target - (6-i), 7));
                    p.hand[i].value = v; sum += v; target -= v;
                }
                p.hand[6].value = target;
            }
        });
        renderAssignScreen();
    }

    function renderAssignScreen() {
        showScreen('assign-screen');
        const list = document.getElementById('assign-list');
        list.innerHTML = '';
        players[0].hand.forEach((card, i) => {
            const row = document.createElement('div');
            row.className = 'assign-row';
            row.innerHTML = `
                <input type="checkbox" class="a-cb" onchange="updateAssignUI()">
                <div class="card ${card.suit}" style="margin:0; width:32px; height:45px"></div>
                <input type="number" class="a-iv" value="0" min="0" max="21" oninput="updateAssignUI()">
            `;
            list.appendChild(row);
        });
        updateAssignUI();
    }

    function autoAssign() {
        const cbs = document.querySelectorAll('.a-cb');
        const ivs = document.querySelectorAll('.a-iv');
        let indices = [0,1,2,3,4,5,6,7,8].sort(()=>Math.random()-0.5).slice(0,7);
        cbs.forEach((cb, i) => cb.checked = indices.includes(i));
        let points = [0,0,0,0,0,0,0], sum = 0;
        while(sum < 21) {
            let r = Math.floor(Math.random()*7);
            if(points[r] < 7) { points[r]++; sum++; }
        }
        let pIdx = 0;
        ivs.forEach((iv, i) => {
            if(indices.includes(i)) { iv.value = points[pIdx++]; }
            else { iv.value = 0; }
        });
        updateAssignUI();
    }

    function updateAssignUI() {
        let count = 0, sum = 0;
        document.querySelectorAll('.a-cb').forEach((cb, i) => {
            if(cb.checked) {
                count++;
                sum += parseInt(document.querySelectorAll('.a-iv')[i].value) || 0;
            }
        });
        document.getElementById('sel-count').innerText = count;
        document.getElementById('current-sum').innerText = sum;
        document.getElementById('assign-done-btn').disabled = (count !== 7 || sum !== 21);
    }

    function finishAssignment() {
        let selected = [];
        document.querySelectorAll('.a-cb').forEach((cb, i) => {
            if(cb.checked) {
                let card = players[0].hand[i];
                card.value = parseInt(document.querySelectorAll('.a-iv')[i].value) || 0;
                selected.push(card);
            }
        });
        players[0].hand = selected;
        startTrick();
    }

    function startTrick() {
        showScreen('main-screen');
        currentTrick = [];
        trickLeadSuit = null;
        currentPlayerIdx = firstPlayerIdx;
        renderScoreArea();
        nextTurn();
    }

    function nextTurn() {
        const p = players[currentPlayerIdx];
        renderTable();
        if(p.isAI) {
            document.getElementById('turn-info').innerText = `${p.name} æ€è€ƒä¸­...`;
            setTimeout(() => aiPlay(p), 700);
        } else {
            document.getElementById('turn-info').innerText = `ä½ çš„å›åˆ - è¯·å‡ºç‰Œ`;
            renderHumanHand();
        }
    }

    function renderHumanHand() {
        const area = document.getElementById('hand-area');
        area.innerHTML = '';
        const canFollow = players[0].hand.some(c => c.suit === trickLeadSuit);
        players[0].hand.forEach((card, i) => {
            const div = document.createElement('div');
            const isLegal = !trickLeadSuit || card.suit === trickLeadSuit || !canFollow;
            div.className = `card ${card.suit} ${isLegal ? '' : 'disabled'}`;
            div.innerHTML = `<span class="card-val">${card.value}</span>`;
            div.onclick = () => {
                if(!isLegal) return;
                document.querySelectorAll('#hand-area .card').forEach(c => c.classList.remove('selected'));
                div.classList.add('selected');
                div.dataset.index = i;
                document.getElementById('play-btn').style.display = 'block';
            };
            area.appendChild(div);
        });
    }

    function humanPlay() {
        const sel = document.querySelector('.card.selected');
        if(!sel) return;
        const idx = parseInt(sel.dataset.index);
        document.getElementById('play-btn').style.display = 'none';
        executeCard(0, idx);
    }

    function aiPlay(p) {
        const canFollow = p.hand.filter(c => c.suit === trickLeadSuit);
        let idx = -1;
        if(trickLeadSuit && canFollow.length > 0) {
            idx = p.hand.indexOf(canFollow[Math.floor(Math.random()*canFollow.length)]);
        } else {
            idx = Math.floor(Math.random()*p.hand.length);
        }
        executeCard(p.id, idx);
    }

    function executeCard(pIdx, cardIdx) {
        const card = players[pIdx].hand.splice(cardIdx, 1)[0];
        if(!trickLeadSuit) trickLeadSuit = card.suit;
        currentTrick.push({pIdx, card});
        if (pIdx === 0) renderHumanHand(); 
        renderTable();
        currentPlayerIdx = (currentPlayerIdx + 1) % playerCount;
        if(currentTrick.length === playerCount) {
            setTimeout(resolveTrick, 800);
        } else {
            nextTurn();
        }
    }

    function resolveTrick() {
        const getValid = (list) => {
            const counts = {};
            list.forEach(t => counts[t.card.value] = (counts[t.card.value] || 0) + 1);
            return list.filter(t => counts[t.card.value] === 1);
        };
        let leadCards = currentTrick.filter(t => t.card.suit === trickLeadSuit);
        let validLeads = getValid(leadCards);
        let winnerObj = null;
        if(validLeads.length > 0) {
            winnerObj = validLeads.sort((a,b) => b.card.value - a.card.value)[0];
        } else {
            let otherCards = currentTrick.filter(t => t.card.suit !== trickLeadSuit);
            let validOthers = getValid(otherCards);
            if(validOthers.length > 0) {
                winnerObj = validOthers.sort((a,b) => b.card.value - a.card.value)[0];
            }
        }
        const log = document.getElementById('msg-log');
        if(!winnerObj) {
            log.innerText = "âš ï¸ æ‰“å¹³æŠµæ¶ˆï¼Œå¡ç‰Œå¼ƒç½®";
            currentScoreCards[currentScoreCardIdx].status = 'discarded';
            firstPlayerIdx = (currentTrick[0].pIdx + 1) % playerCount;
        } else if(winnerObj.card.value === 0) {
            log.innerText = `${players[winnerObj.pIdx].name} ç”¨ 0 èµ¢ï¼Œå¡ç‰Œå¼ƒç½®`;
            currentScoreCards[currentScoreCardIdx].status = 'discarded';
            firstPlayerIdx = winnerObj.pIdx;
        } else {
            const points = currentScoreCards[currentScoreCardIdx][winnerObj.card.suit];
            players[winnerObj.pIdx].score += points;
            log.innerText = `ğŸ† ${players[winnerObj.pIdx].name} èµ¢ (${points}åˆ†)`;
            firstPlayerIdx = winnerObj.pIdx;
        }
        currentScoreCardIdx++;
        setTimeout(() => {
            log.innerText = "";
            renderScoreArea();
            if(currentScoreCardIdx >= 7) endRound();
            else startTrick();
        }, 1200);
    }

    function endRound() {
        if(round >= 3) {
            showFinalResults();
            return;
        }
        round++;
        const min = Math.min(...players.map(p => p.score));
        const candidates = players.filter(p => p.score === min);
        firstPlayerIdx = candidates[Math.floor(Math.random()*candidates.length)].id;
        startRound();
    }

    function showFinalResults() {
        document.getElementById('common-header').style.display = 'none';
        showScreen('result-screen');
        const list = document.getElementById('final-ranking');
        list.innerHTML = '';
        const sorted = [...players].sort((a,b) => b.score - a.score);
        sorted.forEach((p, i) => {
            const item = document.createElement('div');
            item.className = 'ranking-item';
            const color = i===0 ? 'var(--accent-orange)' : '#fff';
            item.innerHTML = `<span style="color:${color}">${i===0?'ğŸ‘‘ ':''}#${i+1} ${p.name}</span><span style="color:${color}">${p.score} åˆ†</span>`;
            list.appendChild(item);
        });
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function renderScoreArea() {
        const area = document.getElementById('score-cards-area');
        area.innerHTML = '';
        currentScoreCards.forEach((sc, i) => {
            const div = document.createElement('div');
            div.className = `score-card ${i===currentScoreCardIdx?'active':''} ${sc.status==='discarded'?'discarded':''}`;
            div.innerHTML = `<span style="color:var(--card-yellow)">é»„:${sc.yellow}</span><span style="color:var(--card-red)">çº¢:${sc.red}</span><span style="color:var(--card-blue)">è“:${sc.blue}</span>`;
            area.appendChild(div);
        });
    }

    function renderTable() {
        const table = document.getElementById('table');
        table.innerHTML = '';
        const radius = 90;
        currentTrick.forEach((t, i) => {
            const angle = (t.pIdx * (360/playerCount) - 90) * (Math.PI/180);
            const x = Math.cos(angle)*radius, y = Math.sin(angle)*radius;
            const slot = document.createElement('div');
            slot.className = 'table-slot';
            slot.style.left = `calc(50% + ${x}px - 23px)`;
            slot.style.top = `calc(50% + ${y}px - 35px)`;
            slot.innerHTML = `<div class="card ${t.card.suit}" style="margin:0"><span class="card-val">${t.card.value}</span></div><div style="font-size:10px; color:#666">${players[t.pIdx].name}</div>`;
            table.appendChild(slot);
        });
    }

    function updateStatus() {
        document.getElementById('status-bar').innerHTML = players.map(p => `<span>${p.name}:<b>${p.score}</b></span>`).join('');
    }
</script>
</body>
</html>